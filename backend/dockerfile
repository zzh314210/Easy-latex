FROM texlive/texlive:latest

# ============================
# 1. 只用阿里云的 Debian 源
# ============================
RUN set -eux; \
    # 干掉可能自带的其他源配置（包含 deb.debian.org 那些）
    rm -f /etc/apt/sources.list.d/* || true; \
    mkdir -p /etc/apt; \
    # 写入阿里云源
    printf '%s\n' \
      'deb http://mirrors.aliyun.com/debian testing main contrib non-free non-free-firmware' \
      'deb http://mirrors.aliyun.com/debian-security testing-security main contrib non-free non-free-firmware' \
      'deb http://mirrors.aliyun.com/debian testing-updates main contrib non-free non-free-firmware' \
      > /etc/apt/sources.list; \
    apt-get clean; \
    apt-get update; \
    apt-get install -y --no-install-recommends \
        python3 \
        python3-pip \
        unzip \
        p7zip-full \
        unrar; \
    rm -rf /var/lib/apt/lists/*

# ============================
# 2. pip 换阿里云源（Python 包）
# ============================
RUN pip3 config set global.index-url https://mirrors.aliyun.com/pypi/simple/

# ============================
# 3. 安装 FastAPI / Uvicorn 等依赖
#    关键在这里：加 --break-system-packages
# ============================
RUN pip3 install --break-system-packages --no-cache-dir fastapi uvicorn[standard] python-multipart

# ============================
# 4. 代码与启动命令
# ============================
WORKDIR /app

COPY main.py /app/main.py

ENV PYTHONUNBUFFERED=1

EXPOSE 9999

CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "9999"]
